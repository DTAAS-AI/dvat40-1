<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ANU CVML Video Annotation Tool</title>
  <link rel="stylesheet" href="css/anucvml.css" type="text/css"/>
  <script type="text/javascript" src="js/anno.js"></script>
  <script type="text/javascript" src="js/anuvidlib.js"></script>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript">
    function todo () { window.alert('Not implemented yet!') }
  </script>
</head>
<body onload="init();" onunload="fini();">
<div id="banner">
  <button title="show menu" id="showmenubtn" onclick="showmenu();">&#x2630;</button>
  <img src="img/logo.png" id="logo">
</div>
<center>
  <h1>ANU CVML In-browser Video Annotation Tool</h1>
</center>

<!-- video and annotation input, and configuration -->
<div id="menuoverlaydiv" class="overlay" onclick="hidemenu();"></div>
<div id="menudiv">
  <div id="menupanel" style="background: white; width: 100%; height: 100%; padding: 10px;">
    <div style="position: relative;">
      <button title="hide menu" id="hidemenubtn" onclick="hidemenu();">&lt;&lt;</button>
    </div>

    <h1>Menu</h1>
    <h2>Video</h2>
    <input id="videoinput" type="file" accept="video/*"/>
    <p/>

    <h2>Annotations</h2>
    <span id="annotationinfo" class="hint">(no annotations)</span>
    <p/>
    <button id="loadannobtn" title="load annotations" onclick="v.annotations.load(() => { updateGUI(v); });">
      load...
    </button>
    <button id="saveannobtn" title="save annotations" onclick="v.annotations.save();">save...</button>
    <button id="clearannobtn" title="save annotations" onclick="clearAllAnnotations();">clear all</button>
    <p/>

    <h2>Configuration</h2>
    <span class="hint">List of colon separated label-colour pairs, e.g.,<br>"car: #0000ff"</span>
    <fieldset>
      <legend>Object Labels</legend>
      <textarea id="objectlabels" rows="7" style="width: 170pt; resize: vertical;"
                onblur="v.lblConfig.objectLabels = v.lblConfig.fromString(this.value);"></textarea>
    </fieldset>
    <fieldset>
      <legend>Action Labels</legend>
      <textarea id="actionlabels" rows="7" style="width: 170pt; resize: vertical;"
                onblur="v.lblConfig.actionLabels = v.lblConfig.fromString(this.value);"></textarea>
    </fieldset>
    <p/>
    <button title="load config" onclick="v.lblConfig.load(() => { updateGUI(v); });">load...</button>
    <button title="save config" onclick="v.lblConfig.save();">save...</button>

    <h2>Preferences</h2>
    <span class="hint">Saves in browser local storage.</span>
    <fieldset>
      <legend>Show/hide</legend>
      <input id="showkfcb" checked=true type="checkbox"
             onclick="v.prefs.update('showkeyframes', this.checked, 'keyframesdiv');">
      <label for="showkfcb">Keyframes</label><br>
      <input id="showobjscb" checked=true type="checkbox"
             onclick="v.prefs.update('showobjects', this.checked, 'objectsdiv'); v.redraw();">
      <label for="showobjscb">Objects (bounding boxes)</label><br>
      <input id="showregscb" checked=true type="checkbox" disabled=true>
      <label for="showregscb">Regions (polygon outlines)</label><br>
      <input id="showvidsegcb" checked=true type="checkbox"
             onclick="v.prefs.update('showvidsegs', this.checked, 'vidsegdiv');">
      <label for="showvidsegcb">Video segments</label><br>
    </fieldset>
    <button title="restore defaults" onclick="v.prefs.reset(); updateGUI(v);">defaults</button>
  </div>
</div>

<!-- side-by-side video frame container -->
<div id="container" style="width: 100%;">
  <div id="leftpanel" style="width: 45%; float: left; position: relative;">
    <div class="filmstrip"></div>
    <button title="toggle zoom" onclick="zoom();" style="position: absolute; top: 24px; right: 6px; z-index: 1;">
      &#x1F50D;
    </button>
    <canvas id="leftframe" width="640px" height="480px" style="display: block;"></canvas>
    <div class="filmstrip"></div>
    <br>
    <div style="width: 100%;">
      <input type="range" min="0" max="100" value="0" style="width: 100%;" id="leftslider"
             oninput="v.seekToIndex(this.value, -1)" ;>
      <br>
      <span style="float: right;" id="leftstatus">none</span>
    </div>
  </div>
  <div id="centerpanel" style="width: 10%; min-width: 80pt; float: left; text-align: center; position: relative;">
    <b>Copy</b><br>
    <p/>
    <button onclick="v.copy(ANUVidLib.RIGHT, ANUVidLib.LEFT, false);" title="copy left" type="button"
            style="width: 30%;">&larr;
    </button>
    <button onclick="v.copy(ANUVidLib.LEFT, ANUVidLib.RIGHT, false);" title="copy right" type="button"
            style="width: 30%;">&rarr;
    </button>
    <br>
    <p/>
    <button onclick="v.copy(ANUVidLib.RIGHT, ANUVidLib.LEFT, true);" title="replace left" type="button"
            style="width: 30%;">&#8606;
    </button>
    <button onclick="v.copy(ANUVidLib.LEFT, ANUVidLib.RIGHT, true);" title="replace right" type="button"
            style="width: 30%;">&#8608;
    </button>
    <br>
    <p/>
    <button onclick="todo();" title="interpolate" type="button" style="width: 60%;">&#8611; interp.</button>
    <br>
    <p/>
    <b>Mode</b><br>
    <p/>
    <select id="mode" name="mode">
      <option value="object" selected>Objects</option>
      <option value="region" disabled>Regions</option>
      <option value="skeleton" disabled>Skeletons</option>
    </select>
    <br>
    <p/>
    <b>Options</b><br>
    <p/>
    <input id="tiedcb" type="checkbox" onclick="v.prefs.update('tiedframes', this.checked);">
    <label for="tiedcb">lock sliders</label><br>
    <input id="greycb" type="checkbox" onclick="v.greyframes = this.checked;">
    <label for="greycb">greyscale</label><br>
    <br>
    <p/>
    <b>Frames</b><br>
    <p/>
    <button onclick="v.swap();" title="swap" type="button" style="width: 50%;">&#x21C4; swap</button>
    <p/>
    <button onclick="play();" title="play" type="button" style="width: 50%;">&#x25B6; play</button>
    <p/>
  </div>
  <div id="rightpanel" style="width: 45%; float:left; position: relative;">
    <div class="filmstrip"></div>
    <canvas id="rightframe" width="640px" height="480px" style="display: block;"></canvas>
    <div class="filmstrip"></div>
    <br>
    <div style="width: 100%;">
      <input type="range" min="0" max="100" value="0" style="width: 100%;" id="rightslider"
             oninput="v.seekToIndex(-1, this.value)" ;>
      <br>
      <span style="float: right;" id="rightstatus">none</span>
    </div>
  </div>
  <!-- needed for proper alignment of previous divs -->
  <div style="clear: both;"></div>
</div>

<!-- annotations container -->
<div id="annotations" style="width: 100%;">
  <td id="keyframesdiv">
    <fieldset>
      <legend>Keyframes</legend>
      <table>
        <tr>
          <td>
            <button title="generate" onclick="v.generateKeyframes();">&#x23F2;&nbsp;generate</button>
          </td>
          <td>
            <button title="export" onclick="todo();">&#x1f4be;&nbsp;export</button>
          </td>
          <td style="width: 100%; padding-right: 8pt;">
            <input id="keyframeListId" type="text" style="width: 100%;" onblur="v.setKeyframes(this.value);"
                   onkeypress="defocusOnEnter(event);">
          </td>
          <td>
            <button title="previous" onclick="v.prevKeyframe();">&lt;</button>
          </td>
          <td>
            <button title="next" onclick="v.nextKeyframe();">&gt;</button>
          </td>
        </tr>
      </table>
    </fieldset>
</div>

<div id="objectsdiv">
  <div style="width: 45%; float: left;">
    <fieldset>
      <legend>Objects</legend>
      <div style="float: right;">
        <button title="clear all" onclick="v.clearObjects(ANUVidLib.LEFT);">clear</button>
      </div>
      <div style="clear: both;"></div>
      <table id="leftobjtable" width="100%" style="table-layout: fixed;">
        <tr>
          <th width="40pt">x</th>
          <th width="40pt">y</th>
          <th width="40pt">w</th>
          <th width="40pt">h</th>
          <th>label</th>
          <th>instance</th>
          <th>colour</th>
          <th>score</th>
          <th width="110pt"></th>
        </tr>
      </table>
    </fieldset>
  </div>
  <div style="width: 10%; float: left; text-align: center; position: relative;">&nbsp;</div>
  <div style="width: 45%; float: left;">
    <fieldset>
      <legend>Objects</legend>
      <div style="float: right;">
        <button title="clear all" onclick="v.clearObjects(ANUVidLib.RIGHT);">clear</button>
      </div>
      <table id="rightobjtable" width="100%" style="table-layout: fixed;">
        <tr>
          <th width="40pt">x</th>
          <th width="40pt">y</th>
          <th width="40pt">w</th>
          <th width="40pt">h</th>
          <th>label</th>
          <th>instance</th>
          <th>colour</th>
          <th>score</th>
          <th></th>
        </tr>
      </table>
    </fieldset>
  </div>
  <div style="clear: both;"></div>
</div>

<div id="vidsegdiv">
  <fieldset>
    <legend>Video segments</legend>
    <div style="float: right;">
      <button title="sort" onclick="v.annotations.sortVidSegs(); v.refreshVidSegTable();">&#x21A7; sort</button>
      <button title="add segment" onclick="v.newVidSeg();">&#x271A;</button>
    </div>
    <div style="clear: both;"></div>
    <table id="vidsegtable" width="100%" style="table-layout: fixed;">
      <tr>
        <th width="60pt">start</th>
        <th width="60pt">end</th>
        <th width="120pt">action</th>
        <th width="100%">description</th>
        <th width="160pt" align="right"></th>
      </tr>
    </table>
  </fieldset>
</div>
</div>

<!-- object bounding box popup -->
<div id="objectinfo" class="popup">
  <font color="red">testing</font><br>
  <b>label id:</b> TODO<br>
  <b>instance id:</b> TODO<br>
  <b>colour:</b> TODO<br>
</div>

<!-- overlay player window -->
<div id="playeroverlay" class="overlay">
  <span class="overlayclosebtn" onclick="this.parentElement.style.display = 'none';">&times;</span>
  <div class="centered">
    <div class="filmstrip"></div>
    <video style="width: 100%; display: block;" autoplay id="vidplayer"></video>
    <div class="filmstrip"></div>
    <button onclick="document.getElementById('vidplayer').load();" type="button" style="width: 10%; float: left;">
      &#x25B6; replay
    </button>
    <button
      onclick="document.getElementById('vidplayer').pause(); document.getElementById('playeroverlay').style.display = 'none';"
      type="button" style="width: 10%; float: right;">&#x25FC; stop
    </button>
    <div style="clear: both;"></div>
  </div>
</div>

<!-- overlay help window -->
<div id="helpoverlay" class="overlay">
  <div class="centered" style="background: white; padding: 10px;">
    <span class="overlayclosebtn" onclick="this.parentElement.parentElement.style.display = 'none';">&times;</span>
    <!-- <center><small>Version <span id="version">0.0</span></small></center> -->

    <b>Help</b><br>
    Click the top-left menu button (&#x2630) to load and save data.<br>
    Click and drag on frame to add a new bounding box.
    <p/>

    <b>Keyboard Shortcuts</b><br>
    <pre>
    h           :: help (this window)
    p           :: play video segment
    comma, <    :: advance to next keyframe
    period, >   :: retreat to previous keyframe
    [, {        :: select left slider
    ], }        :: select right slider
    left-arrow  :: previous frame (when slider is selected)
    right-arrow :: next frame (when slider is selected)
    page-up     :: jump to previous 10% of video (when slider is selected)
    page-down   :: jump to next 10% of video (when slider is selected)
    plus (+)    :: add a new segment
    delete      :: delete currently active object
    shift       :: duplicate currently active object when mouse down
    tab         :: move to next field when editing objects
</pre>
    <p/>

    <b>Tutorial Videos</b><br>
    <ol>
      <li> coming soon...
    </ol>
  </div>
</div>

<!-- overlay about window -->
<div id="aboutoverlay" class="overlay">
  <div class="centered" style="background: white; padding: 10px;">
    <span class="overlayclosebtn" onclick="this.parentElement.parentElement.style.display = 'none';">&times;</span>
    <center><small>Version <span id="version">0.0</span></small></center>
    <b>About</b><br>
    Developed by the Australian National University Machine Learning and Computer Vision group
    as a high quality yet simple and efficient to use open-source video annotation tool.
    <p/>

    <b>Contributors</b><br>
    <ul>
      <li>Stephen Gould</li>
      <li>TODO</li>
    </ul>
    <p/>
  </div>
</div>


<p/>
<address>
  Copyright &copy; 2020, Stephen Gould. All rights reserved.<br>
  <span onclick="showabout();" class="textlink">about</span> |
  <span onclick="showhelp();" class="textlink">help</span> |
  <a href='mailto:stephen.gould@anu.edu.au' class="textlink">contact</a>
</address>

</body>
</html>
