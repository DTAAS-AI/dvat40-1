<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANU CVML Video Annotation Tool</title>
    <link rel="stylesheet" href="anucvml.css" type="text/css"/>
    <script type="text/javascript" src="anno.js"></script>
    <script type="text/javascript" src="anuvidlib.js"></script>
    <script type="text/javascript">
        function todo() { window.alert("Not implemented yet!"); }

        function randbox() {
            let frameIndex = v.time2indx(v.leftPanel.timestamp);
            let x = 0.9 * Math.random();
            let y = 0.9 * Math.random();
            let w = (0.9 - x) * Math.random() + 0.1;
            let h = (0.9 - y) * Math.random() + 0.1;
            v.annotations.objectList[frameIndex].push(new ObjectBox(x, y, w, h, null, null, '#' + Math.random().toString(16).substr(2,6)));
            v.redraw(ANUVidLib.BOTH);
        }
    </script>
    <script type="text/javascript">
        // configuration
        var config = {version: VERSION, tiedcb: false, greycb: false};
        if (typeof(Storage) !== "undefined") {
            if (localStorage.getItem("anucvml:config") != null) {
                config = JSON.parse(localStorage.getItem("anucvml:config"));
            }
        }

        var v = null;

        function init() {
            v = new ANUVidLib();

            var loadVideoFile = function(event) {
                var file = this.files[0];
                var fileURL = URL.createObjectURL(file);
                v.loadVideo(fileURL);
                hidemenu();
            }

            var input = document.querySelector('#videoinput');
            input.addEventListener('change', loadVideoFile, false);
            document.getElementById("version").innerHTML = VERSION;
            if (config.tiedcb) document.getElementById("tiedcb").click();
            if (config.greycb) document.getElementById("greycb").click();
        }

        function fini() {
            config.tiedcb = document.getElementById("tiedcb").checked;
            config.greycb = document.getElementById("greycb").checked;
            try {
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem("anucvml:config", JSON.stringify(config));
                }
            } catch(err) {
                // do nothing
            }
        }

        function play() {
            if (isNaN(v.video.duration)) {
                return;
            }
            document.getElementById('playeroverlay').style.display = 'block';
            var startTime = Math.min(v.leftPanel.timestamp, v.rightPanel.timestamp);
            var endTime = Math.max(v.leftPanel.timestamp, v.rightPanel.timestamp);
            document.getElementById('vidplayer').src = v.video.src + "#t=" + startTime + "," + endTime;
        }

        // toggle zoom
        function zoom() {
            if (document.getElementById('rightpanel').style.display === 'none') {
                document.getElementById('leftpanel').style.width = '45%';
                document.getElementById('centerpanel').style.display = 'block';
                document.getElementById('rightpanel').style.display = 'block';
            } else {
                document.getElementById('leftpanel').style.width = '100%';
                document.getElementById('centerpanel').style.display = 'none';
                document.getElementById('rightpanel').style.display = 'none';
            }
            v.resize();
            v.resize();
        }

        function showmenu() {
            let cfg = v.annotations.lblConfig;
            document.getElementById('objectlabels').value = cfg.toString(cfg.objectLabels);;
            document.getElementById('actionlabels').value = cfg.toString(cfg.actionLabels);

            document.getElementById('menudiv').style.display = 'block';
        }

        function hidemenu() {
            let cfg = v.annotations.lblConfig;
            cfg.objectLabels = cfg.fromString(document.getElementById('objectlabels').value);
            cfg.actionLabels = cfg.fromString(document.getElementById('actionlabels').value);

            document.getElementById('menudiv').style.display = 'none';
            v.redraw();
        }

        function showhelp() {
            document.getElementById('helpoverlay').style.display = 'block';
        }

        document.addEventListener('keyup', (e) => { return onkeypress(e); })
        function onkeypress(e) {
            // don't process key if inside a textbox
            if ((e.target.nodeName.toLowerCase() == 'input') && (e.target.type.toLowerCase() == 'text')) {
                return false;
            }
            console.log("key " + e.code + " (0x" + e.keyCode.toString(16) + ")");
            switch (e.keyCode) {
            case 0x2E:  // delete
                v.deleteActiveObject();
                return true;

            case 0x48:  // H
                showhelp(); return true;

            case 0x50:  // P
                play(); return true;

            case 0xBC:  // comma, <
                v.prevKeyframe();
                return true;

            case 0xBE:  // period, >
                v.nextKeyframe();
                return true;

            case 0xBB:  // plus, equals
                newclip(); return true;

            case 0xDB:  // [, {
                document.getElementById('leftslider').focus();
                return true;

            case 0xDD:  // ], }
                document.getElementById('rightslider').focus();
                return true;

            }

            return false;
        }
    </script>
</head>
<body onload="init();" onunload="fini();">
<div id="banner">
    <button title="show menu" id="showmenu" onclick="showmenu();">&#x2630</button>
    <img src="logo.png" id="logo">
</div>
<center>
    <h1>ANU CVML In-browser Video Annotation Tool</h1>
</center>

<!-- video and annotation input, and configuration -->
<div id="menudiv" class="overlay">
    <div style="background: white; width: 200pt; height: 100%; padding: 10px; cursor: auto;">
        <div style="position: relative;">
        <button title="hide menu" id="hidemenu" onclick="hidemenu();">&lt;&lt;</button>
        </div>

        <h1>Menu</h1>
        <h2>Video</h2>
        <input id="videoinput" type="file" accept="video/*"/>
        <p/>

        <h2>Annotations</h2>
        <!-- todo clean up file dialog -->
        <button title="load annotations" onclick="v.annotations.load(() => { showmenu(); v.redraw(); });">load...</button>
        <button title="save annotations" onclick="v.annotations.save();">save...</button>
        <p/>

        <h2>Configuration</h2>
        <span class="hint">List of colon separated label-colour pairs.</span>
        <fieldset>
            <legend>Object Labels</legend>
            <textarea id="objectlabels" rows="8" style="width: 170pt; resize: vertical;"></textarea>
        </fieldset>
        <fieldset>
            <legend>Action Labels</legend>
            <textarea id="actionlabels" rows="8" style="width: 170pt; resize: vertical;"></textarea>
        </fieldset>
        <p/>
        <!-- todo clean up file dialog -->
        <button title="load config" onclick="v.annotations.lblConfig.load(() => { showmenu(); });">load...</button>
        <button title="save config" onclick="v.annotations.lblConfig.save();">save...</button>
    </div>
        </div>
</div>

<!-- side-by-side video frame container -->
<div id="container" style="width: 100%;">
    <div id="leftpanel" style="width: 45%; float: left; position: relative;">
        <div class="filmstrip"></div>
        <button title="toggle zoom" onclick="zoom();" style="position: absolute; top: 24px; right: 6px; z-index: 1;">&#x1F50D;</button>
        <canvas id="leftframe" width="640px" height="480px" style="display: block;"></canvas>
        <div class="filmstrip"></div>
        <br>
        <div style="width: 100%;">
            <input type="range" min="0" max="100" value="0" style="width: 100%;" id="leftslider" oninput="v.seekToIndex(this.value, -1)";>
            <br>
            <span style="float: right;" id="leftstatus">none</span>
        </div>
    </div>
    <div id="centerpanel" style="width: 10%; float: left; text-align: center; position: relative;">
        <b>Copy</b><br><p/>
        <button onclick="v.copy(ANUVidLib.RIGHT, ANUVidLib.LEFT, false);" title="copy left" type="button" style="width: 30%;">&larr;</button>
        <button onclick="v.copy(ANUVidLib.LEFT, ANUVidLib.RIGHT, false);" title="copy right" type="button" style="width: 30%;">&rarr;</button>
        <br><p/>
        <button onclick="v.copy(ANUVidLib.RIGHT, ANUVidLib.LEFT, true);" title="replace left" type="button" style="width: 30%;">&#8606;</button>
        <button onclick="v.copy(ANUVidLib.LEFT, ANUVidLib.RIGHT, true);" title="replace right" type="button" style="width: 30%;">&#8608;</button>
        <br><p/>
        <b>Options</b><br><p/>
        <input id="tiedcb" type="checkbox" onclick="v.tiedframes = this.checked; return true;">
        <label for="tiedcb">tie sliders</label><br>
        <input id="greycb" type="checkbox" onclick="v.greyframes = this.checked; return true;">
        <label for="greycb">greyscale</label><br>
        <br><p/>
        <b>Frames</b><br><p/>
        <button onclick="v.swap();" title="swap" type="button" style="width: 50%;">&#x21C4; swap</button><p/>
        <button onclick="play();" title="play" type="button" style="width: 50%;">&#x25B6; play</button><p/>
    </div>
    <div id="rightpanel" style="width: 45%; float:left; position: relative;">
        <div class="filmstrip"></div>
        <canvas id="rightframe" width="640px" height="480px" style="display: block;"></canvas>
        <div class="filmstrip"></div>
        <br>
        <div style="width: 100%;">
            <input type="range" min="0" max="100" value="0" style="width: 100%;" id="rightslider" oninput="v.seekToIndex(-1, this.value)";>
            <br>
            <span style="float: right;" id="rightstatus">none</span>
        </div>
    </div>
    <!-- needed for proper alignment of previous divs -->
    <div style="clear: both;"></div>
</div>

<!-- annotations container -->
<div id="annotations" style="width: 100%;">
    <fieldset>
        <legend>Keyframes</legend>
            <button title="generate" onclick="v.generateKeyframes();">&#x23F2; generate</button>
            <span id="keyframeListId">(no keyframes)</span>
            <font color="red">TODO: load, export, add/remove, visualize</font>
        <div style="float: right;">
            <button title="previous" onclick="v.prevKeyframe();">&lt;</button>
            <button title="next" onclick="v.nextKeyframe();">&gt;</button>
        </div>
        <div style="clear: both;"></div>
    </fieldset>

    <div id="leftannopanel" style="width: 45%; float: left;">
        <fieldset>
            <legend>Objects</legend>
            <!-- <button onclick="randbox();"><font color="red">TESTING:</font> Random Box</button> -->
            <div style="float: right;"><button title="clear all" onclick="v.clearObjects(ANUVidLib.LEFT);">clear</button></div>
            <div style="clear: both;"></div>
            <table id="leftobjtable" width="100%" style="table-layout: fixed;">
            <tr><th width="40pt">x</th><th width="40pt">y</th><th width="40pt">w</th><th width="40pt">h</th>
                <th>label</th><th>instance</th><th>colour</th><th>score</th><th width="110pt"></th></tr>
            </table>
        </fieldset>
    </div>
    <div style="width: 10%; float: left; text-align: center; position: relative;">&nbsp;</div>
    <div id="rightannopanel" style="width: 45%; float: left;">
        <fieldset>
            <legend>Objects</legend>
            <div style="float: right;"><button title="clear all" onclick="v.clearObjects(ANUVidLib.RIGHT);">clear</button></div>
            <table id="rightobjtable" width="100%" style="table-layout: fixed;">
            <tr><th width="40pt">x</th><th width="40pt">y</th><th width="40pt">w</th><th width="40pt">h</th>
                <th>label</th><th>instance</th><th>colour</th><th>score</th><th></th></tr>
            </table>
        </fieldset>
    </div>
    <div style="clear: both;"></div>

    <fieldset>
        <legend>Video segments</legend>
        <div style="float: right;">
            <button title="sort" onclick="sortclips();">&#x21A7; sort</button>
            <button title="add segment" onclick="newclip();">&#x271A;</button>
        </div>
        <div style="clear: both;"></div>
        <table id="vidsegtable" width="100%" style="table-layout: fixed;">
            <tr><th width="60pt">start</th><th width="60pt">end</th><th width="120pt">action</th><th width="100%">description</th><th width="160pt" align="right"></th></tr>
        </table>
    </fieldset>
</div>

<!-- object bounding box popup -->
<div id="objectinfo" class="popup">
    <font color="red">testing</font><br>
    <b>label id:</b> TODO<br>
    <b>instance id:</b> TODO<br>
    <b>colour:</b> TODO<br>
</div>

<!-- overlay player window -->
<div id="playeroverlay" class="overlay">
    <span class="overlayclosebtn" onclick="this.parentElement.style.display = 'none';">&times;</span>
    <div class="centered">
        <div class="filmstrip"></div>
        <video style="width: 100%; display: block;" autoplay id="vidplayer"></video>
        <div class="filmstrip"></div>
        <button onclick="document.getElementById('vidplayer').load();" type="button" style="width: 10%; float: left;">&#x25B6; replay</button>
        <button onclick="document.getElementById('vidplayer').pause(); document.getElementById('playeroverlay').style.display = 'none';" type="button" style="width: 10%; float: right;">&#x25FC; stop</button>
        <div style="clear: both;"></div>
    </div>
</div>

<!-- overlay help window -->
<div id="helpoverlay" class="overlay">
    <div class="centered" style="background: white; padding: 10px;">
        <span class="overlayclosebtn" onclick="this.parentElement.parentElement.style.display = 'none';">&times;</span>
        <center><small>Version <span id="version">0.0</span></small></center>

        <b>Help</b><br>
        Click the top-left menu button (&#x2630) to load and save data.
        <p/>

        <b>Keyboard Shortcuts</b><br>
<pre>
    h           :: help (this window)
    p           :: play video segment
    comma, <    :: advance to next keyframe
    period, >   :: retreat to previous keyframe
    [, {        :: select left slider
    ], }        :: select right slider
    left-arrow  :: previous frame (when slider is selected)
    right-arrow :: next frame (when slider is selected)
    page-up     :: jump to previous 10% of video (when slider is selected)
    page-down   :: jump to next 10% of video (when slider is selected)
    plus (+)    :: add a new segment
    delete      :: delete currently active object
    shift       :: duplicate currently active object when mouse down
    tab         :: move to next field when editing objects
</pre>
        <p/>

        <b>Tutorial Videos</b><br>
        <ol>
            <li> coming soon...
        </ol>
    </div>
</div>


<p/>
<address>
    Copyright &copy; 2020, Stephen Gould. All rights reserved.<br>
    <span onclick="todo();" class="textlink">about</span> |
    <span onclick="showhelp();" class="textlink">help</span> |
    <a href='mailto:stephen.gould@anu.edu.au' class="textlink">contact</a>
</address>

</body>
</html>